name: Build and Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Pull Latest Code
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            PROJECT_DIR=~/SWTS_Website

            if [ ! -d "$PROJECT_DIR" ]; then
              echo "Cloning repository..."
              git clone https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ vars.GH_ORG }}/${{ vars.GH_REPO }}.git "$PROJECT_DIR"
            else
              cd "$PROJECT_DIR"
              git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ vars.GH_ORG }}/${{ vars.GH_REPO }}.git
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            fi
          ENDSSH

      - name: Deploy Application
        env:
          DEPLOY_DOMAIN: ${{ vars.DOMAIN }}
          NGINX_CONTAINER: ${{ vars.SHARED_NGINX_CONTAINER || 'logs_nginx' }}
          PROJECT_CONFIG: ${{ vars.NGINX_CONFIG_NAME || 'swts.conf' }}
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << ENDSSH
            set -e
            cd ~/SWTS_Website

            # Determine docker command
            if groups | grep -q docker; then
              DOCKER_CMD="docker"
            else
              DOCKER_CMD="sudo docker"
            fi

            echo "=========================================="
            echo "Deploying SWTS_Website"
            echo "Domain: $DEPLOY_DOMAIN"
            echo "=========================================="

            # Update domain in nginx config
            sed -i "s/server_name .*/server_name $DEPLOY_DOMAIN;/" nginx/conf.d/$PROJECT_CONFIG

            # Stop old containers and force remove any conflicting ones
            echo "Stopping existing containers..."
            \$DOCKER_CMD compose -f docker-compose.shared.yml down --remove-orphans || true

            # Force remove containers if they still exist (handles naming conflicts)
            echo "Cleaning up any leftover containers..."
            \$DOCKER_CMD rm -f swts_app swts_certbot 2>/dev/null || true

            # Build and start
            echo "Building..."
            \$DOCKER_CMD compose -f docker-compose.shared.yml build --no-cache

            echo "Starting..."
            \$DOCKER_CMD compose -f docker-compose.shared.yml up -d

            echo "Waiting for app to be healthy..."
            sleep 15

            # Update nginx config (no restart, just reload)
            echo "Updating nginx configuration..."
            NGINX_CONTAINER="$NGINX_CONTAINER"

            if \$DOCKER_CMD container inspect \$NGINX_CONTAINER >/dev/null 2>&1; then
              # Copy config to nginx
              \$DOCKER_CMD cp nginx/conf.d/$PROJECT_CONFIG \$NGINX_CONTAINER:/etc/nginx/conf.d/$PROJECT_CONFIG

              # Test and reload
              echo "Testing nginx config..."
              \$DOCKER_CMD exec \$NGINX_CONTAINER nginx -t

              echo "Reloading nginx..."
              \$DOCKER_CMD exec \$NGINX_CONTAINER nginx -s reload

              echo "Nginx reloaded successfully!"
            else
              echo "ERROR: Shared nginx container not found!"
              echo "Make sure the first project (ubuntu-docker-logs-finder) is deployed."
              exit 1
            fi

            echo "Deployment complete!"
          ENDSSH

      - name: Setup SSL (Optional)
        env:
          DEPLOY_DOMAIN: ${{ vars.DOMAIN }}
          SSL_EMAIL: ${{ vars.SSL_EMAIL || 'admin@example.com' }}
          NGINX_CONTAINER: ${{ vars.SHARED_NGINX_CONTAINER || 'logs_nginx' }}
          PROJECT_CONFIG: ${{ vars.NGINX_CONFIG_NAME || 'swts.conf' }}
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << ENDSSH
            set -e
            cd ~/SWTS_Website

            if groups | grep -q docker; then
              DOCKER_CMD="docker"
            else
              DOCKER_CMD="sudo docker"
            fi

            CERT_PATH="/home/ubuntu/ubuntu-docker-logs-finder/certbot/conf/live/$DEPLOY_DOMAIN"

            # Check if certificate already exists
            if [ -d "\$CERT_PATH" ]; then
              echo "SSL certificate already exists for $DEPLOY_DOMAIN"
            else
              echo "Obtaining SSL certificate for $DEPLOY_DOMAIN..."

              # Use docker run directly to avoid entrypoint override issues
              \$DOCKER_CMD run --rm \
                -v /home/ubuntu/ubuntu-docker-logs-finder/certbot/www:/var/www/certbot \
                -v /home/ubuntu/ubuntu-docker-logs-finder/certbot/conf:/etc/letsencrypt \
                --network shared_proxy_network \
                certbot/certbot certonly \
                --webroot \
                --webroot-path=/var/www/certbot \
                --email "$SSL_EMAIL" \
                --agree-tos \
                --no-eff-email \
                --non-interactive \
                -d "$DEPLOY_DOMAIN"

              echo "Certificate obtained!"
            fi
          ENDSSH

      - name: Verify Deployment
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            cd ~/SWTS_Website

            if groups | grep -q docker; then
              DOCKER_CMD="docker"
            else
              DOCKER_CMD="sudo docker"
            fi

            # Check containers
            echo "Container status:"
            $DOCKER_CMD compose -f docker-compose.shared.yml ps

            # Health check
            sleep 3
            if curl -sf http://localhost:5002/ > /dev/null 2>&1; then
              echo "Health check passed!"
            else
              echo "Warning: Health check on localhost:5002 failed"
              $DOCKER_CMD compose -f docker-compose.shared.yml logs --tail=20
            fi
          ENDSSH
